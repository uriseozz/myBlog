<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bulma CSS ë§í¬ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">

    <meta property="og:title" content="ë‚˜ë§Œì˜ í•­í•´ ë¸”ë¡œê·¸"/>
    <meta property="og:description" content="í•­í•´99 spring PJ"/>
    <meta property="og:image" content="images/og_img.jpg"/>

    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="/images/icons/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css">
    <!--===============================================================================================-->

    <title>í•­í•´99 ë¸”ë¡œê·¸</title>

</head>
<body>
<div class="limiter">
    <div class="container-table100">
        <div>
            <img id="banner" src="/images/banner_img.png" alt="">
        </div>
        <div id="user-btn">
            <div sec:authorize="isAuthenticated()" id="login-win">
                <div id="header-title-login-user">
                    <span th:text="${user}"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ğŸ˜ƒ
                </div>
                <form id="my_form" method="post" action="/user/logout">
                    <button class="button" onclick="document.getElementById('my_form').submit();">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()" id="logout-win" >
                <div>
                    <a href="/user/login"><button class="button" id="login-btn">ë¡œê·¸ì¸</button></a>
                </div>
                <div>
                    <a href="/user/signup"><button class="button" id="signup-btn">íšŒì›ê°€ì…</button></a>
                </div>
            </div>
        </div>

        <div class="content-container">

            <h2 class="title"><span th:text="${posting.title}"></span></h2>
<!--            <br>-->
            <div class="bar">
                <h5 class="subtitle is-5" style="display: block;"><label>ì‘ì„±ì : </label><span th:text="${posting.user.username}"></span></h5>
                <button th:if="${posting.user.username} == ${user}"
                        th:onclick="deleteOne([[${posting.id}]])"
                        style="display: block;"
                        id="posting_delete"
                        class="button is-danger">ì‚­ì œ
                </button>
            </div>

            <div class="box">
                <p th:text="${posting.contents}"></p>
            </div>
            <div>
                <button class="button" id="close-button" onclick="location.href='/'">ë‹«ê¸°</button>
            </div>
        </div>
        <br>
        <hr>
        <br>
        <div class="comment-container">
            <!-- ëŒ“ê¸€ ì°½-->
            <form th:action="@{/api/postings/}+${posting.id}+@{/comment}" onsubmit="return check1()" method="post"
                  th:object="${postcomment}">
                <h5 class="subtitle is-5">ëŒ“ê¸€ ë‚¨ê¸°ê¸°</h5>
                <br>
                <!-- ëŒ“ê¸€ ì‘ì„±í•˜ê¸°-->
                <div class="input-comment">
                    <input class="input is-success" type="text" th:field="*{comment}" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”">
                    <button type="submit" class="button is-success">ë“±ë¡</button>
                </div>
            </form>
            <br>

            <!--ëŒ“ê¸€ ëª©ë¡-->
            <div class="box" th:each="comment : ${comment}">
                <p th:text="${comment.user.username}"></p>
                <br>
                <p th:id="${comment.id}+commnet" th:text="${comment.comment}"></p>

                <!-- ìˆ˜ì • ë²„íŠ¼-->
                <div class="edit-btn">
                    <button class="button is-warning is-light is-small"
                            th:if="${comment.user.username} == ${user}"
                            th:id="${comment.id}+editComment"
                            th:onclick="editComment([[${comment.id}]])"
                            style="display: block;">ìˆ˜ì •
                    </button>


                    <!--ëŒ“ê¸€ ì‚­ì œ-->
                    <button class="button is-danger is-light is-small"
                            th:if="${comment.user.username} == ${user}"
                            th:id="${comment.id}+removeComment"
                            th:onclick="deleteComment([[${posting.id}]],[[${comment.id}]])"
                            style="display: block; margin-left: 15px">ì‚­ì œ
                    </button>
                </div>

                <!--ëŒ“ê¸€ ìˆ˜ì •-->
                <div class="edit">

                    <input class="input is-success" type="text"
                           th:id="${comment.id}+editinput"
                           style="display:none;">
                    <button class="button is-warning is-light is-small"
                            th:id="${comment.id}+submit"
                            th:onclick="editText([[${posting.id}]],[[${comment.id}]])"
                            style="display:none; margin-left: 10px"> ìˆ˜ì • ì™„ë£Œ </button>


                    <button class="button is-danger is-light is-small" th:id="${comment.id}+cancle"
                            th:onclick="returnComment([[${comment.id}]])" style="display: none; margin-left: 10px">ì·¨ì†Œ
                    </button>
                </div>


            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    // í¬ìŠ¤íŒ… ì‚­ì œ
    function deleteOne(id) {
        $.ajax({
            type: "DELETE",
            url: `/api/postings/${id}`,
            success: function (response) {
                console.log(response)
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.replace("/");
            }
        })
    }

    //ìˆ˜ì • ë²„íŠ¼ ëˆ„ë¥´ë©´
    function editComment(id) {
        // $(`#${id}editdiv`).show();
        $(`#${id}editinput`).show();  //comment ìˆ˜ì • input
        $(`#${id}submit`).show();  //ìˆ˜ì •ì™„ë£Œë²„íŠ¼
        $(`#${id}cancle`).show();  //ì·¨ì†Œë²„íŠ¼
        $(`#${id}comment`).hide();  //commetì…ë ¥ input
        $(`#${id}removeComment`).hide();  //ì‚­ì œë²„íŠ¼
        $(`#${id}editComment`).hide();  //ìˆ˜ì • ë²„íŠ¼

        // // ìˆ˜ì • input -> comment input ë³€ê²½
        // let comment = $(`#${id}comment`).text();
        // $(`#${id}editinput`).val(comment);
    }

    //ìˆ˜ì • ì·¨ì†Œí•˜ë©´
    function returnComment(id) {
        // $(`#${id}editdiv`).hide();
        $(`#${id}editinput`).hide();  //comment ìˆ˜ì • input
        $(`#${id}submit`).hide();  //ìˆ˜ì •ì™„ë£Œ ë²„íŠ¼
        $(`#${id}cancle`).hide();  //ì·¨ì†Œë²„íŠ¼
        $(`#${id}comment`).show();  // commentì…ë ¥ input
        $(`#${id}editComment`).show(); //ìˆ˜ì • ë²„íŠ¼
        $(`#${id}removeComment`).show();  //ì‚­ì œ ë²„íŠ¼

    }


    // comment ì‚­ì œ
    function deleteComment(id, commentId) {
        $.ajax({
            type: "DELETE",
            url: `/api/postings/${id}/comment/${commentId}`,
            success: function (response) {
                console.log(response)
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.reload();
            }
        })
    }



    // comment ìˆ˜ì •
    function editText(id, commentId) {
        // /api/postings/{id}/comment/{commentId}

        // private String comment;
        // private User user;
        // private Posting posting;
        let comment = $(`#${commentId}editinput`).val();
        let data = {'comment': comment};
        console.log(data)

        $.ajax({
            type: 'PUT',
            url: `/api/postings/${id}/comment/${commentId}`,
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                console.log(response)
                console.log(commentId)
                window.location.reload();
            }
        })
    }


    //comment input check
    function check1() {
        let comment = document.getElementById('comment').value;
        let user = /*[[ ${user} ]]*/null;
        if (comment === "") {
            alert("ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (user == 'null') {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.")
            window.location.replace("/user/login")
            return false
        }
    }

    // comment edit check
    function check2(id){

        let editcomment =document.getElementById(id+'editinput').value;
        if(editcomment === ""){
            alert("ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        return true;
    }

</script>

</body>
</html>